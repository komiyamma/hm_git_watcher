# HmGitWatcher プロジェクトの問題点分析

このドキュメントは、`HmGitWatcher` プロジェクトのコードベースを分析し、特定された技術的な問題点や改善点をまとめたものです。

## 1. [深刻] C#ソースコードの二重管理

**問題点:**

`.NET Framework 4.8` 向けのプロジェクト (`src/4.8/`) と `.NET 8.0` 向けのプロジェクト (`src/8.0/`) で、C#のソースコード (`.cs` ファイル) が完全に重複しています。

- `src/4.8/HmGitWatcherFW/SorceCopyFrom_4.8_To_8.0.bat` というバッチファイルが存在し、手動で `4.8` から `8.0` へソースファイルをコピーする運用になっていることが確認されました。
- ファイル名 (`このフォルダのcsファイルは全部4.8のコピー.txt`) からも、この運用が意図されたものであることが示唆されています。

**リスク:**

- **メンテナンス性の著しい低下:** 機能追加やバグ修正を両方のプロジェクトに反映させる必要があり、修正漏れや同期ズレのリスクが非常に高いです。
- **ビルドプロセスの煩雑化:** 手動でのコピー作業が必要なため、ビルドプロセスが自動化されておらず、人為的ミスを誘発します。

**改善案:**

- **共有プロジェクトの導入:** Visual Studioの共有プロジェクト機能を利用し、両方のソリューション (`.sln`) から共通のソースコードを参照するように変更します。
- **MSBuildのファイルリンク機能の活用:** `.csproj` ファイルを編集し、片方のプロジェクトのソースファイルをリンクとして参照するように構成します。

---

## 2. [重要] 秀丸マクロ(JavaScript)の脆弱なロジック

**問題点:**

`HmGitWatcherMain.js` 内で、Gitリポジトリの状態を判断するために `git status` コマンドの実行結果に含まれる特定の文字列 (`'use "git pull"'`) をチェックしています。

**リスク:**

- **将来のGitバージョンへの非互換性:** Gitのバージョンアップによってコマンドの出力文言が変更された場合、このロジックは即座に破綻します。
- **国際化(i18n)への非対応:** OSの言語設定によっては `git` コマンドの出力が翻訳される可能性があり、その場合も機能しなくなります。

**改善案:**

- **Porcelainフォーマットの利用:** `git status --porcelain` のように、機械可読性を目的とした安定的な出力形式を利用して状態を判断するように変更します。
- **終了コードの確認:** コマンドの成否や特定の状態を、文字列ではなく終了コードで判定するロジックを検討します。

---

## 3. [軽微] JavaScriptコードの品質に関する懸念

**問題点:**

`HmGitWatcherMain.js` をはじめとするJavaScriptコードに、いくつかの品質的な懸念が見られます。

- **グローバル変数の多用:** `gRepoFullPath` などのグローバル変数が使用されており、意図しない副作用やコードの可読性低下を招いています。開発者自身もコメントで懸念を示しています (`// 本当はグローバルにはしたくないが...`)。
- **不適切なエラーハンドリング:** `try...catch(e) {}` のように、発生したエラーを握りつぶす実装が散見されます。これにより、問題発生時のデバッグが困難になります。
- **マジックナンバー/マジックストリング:** COMオブジェクトのGUIDやステータスを表す `0`, `1` といった値がコード内に直接記述されており、可読性とメンテナンス性を損なっています。
- **不安定な動作を示唆するコメント:** `// なぜか必要。` といったコメントは、コードの挙動が完全には理解されておらず、潜在的なバグが存在する可能性を示唆しています。

**改善案:**

- **スコープの限定:** 変数のスコープを可能な限り限定し、グローバル変数の使用を避けます。
- **エラーロギング:** `catch` ブロックでは、少なくともエラー情報を秀丸エディタの出力ペインなどに出力し、問題の追跡を容易にします。
- **定数の活用:** マジックナンバーや文字列は定数として定義し、コードの意図を明確にします。

---

## 4. [軽微] VSCode連携における非効率なプロセス間通信

**問題点:**

秀丸エディタからVSCodeを操作する際、一時フォルダに特定のファイル (`HmOpenVSCodeFromHidemaru.txt`) を作成し、VSCode拡張機能側でそのファイルの存在をポーリングして検知するという方式が取られています。

**リスク:**

- **信頼性の欠如:** ファイルの生成・削除のタイミングによっては、意図通りに連携が動作しない可能性があります。
- **非効率性:** ファイルシステムのポーリングは、リソースの観点から非効率です。

**改善案:**

- **カスタムURIスキームの利用:** `vscode://file/path/to/project` のようなVSCodeがサポートするカスタムURIスキームを利用して、より直接的かつ堅牢に連携する方式に変更します。

---

## 5. [軽微] その他の問題点

- **ファイル名のタイポ:** `SorceCopyFrom_4.8_To_8.0.bat` は `Source...` のタイポです。
- **ドキュメントの不整合:** `README.md` には `.NET 9.0` 対応と記載されていますが、プロジェクトのディレクトリ名は `8.0` となっており、情報が一致していません。
